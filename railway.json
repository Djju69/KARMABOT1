{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "pip install -r requirements.txt",
    "installCommand": "pip install --upgrade pip setuptools wheel && apt-get update && apt-get install -y --no-install-recommends gcc python3-dev",
    "startCommand": "sh -c 'python3 main_v2.py & BOT_PID=$!; python3 -m uvicorn web.main:app --host 0.0.0.0 --port ${PORT:-8080} --proxy-headers --forwarded-allow-ips=\"*\" --timeout-keep-alive 30 & WEB_PID=$!; while kill -0 $BOT_PID 2>/dev/null && kill -0 $WEB_PID 2>/dev/null; do sleep 1; done; if ! kill -0 $BOT_PID 2>/dev/null; then wait $BOT_PID; S=$?; echo Bot exited:$S; kill $WEB_PID 2>/dev/null || true; wait $WEB_PID || true; exit $S; else wait $WEB_PID; S=$?; echo Web exited:$S; kill $BOT_PID 2>/dev/null || true; wait $BOT_PID || true; exit $S; fi'"
  },
  "deploy": {
    "startCommand": "sh -c 'python3 main_v2.py & BOT_PID=$!; python3 -m uvicorn web.main:app --host 0.0.0.0 --port ${PORT:-8080} --proxy-headers --forwarded-allow-ips=\"*\" --timeout-keep-alive 30 & WEB_PID=$!; while kill -0 $BOT_PID 2>/dev/null && kill -0 $WEB_PID 2>/dev/null; do sleep 1; done; if ! kill -0 $BOT_PID 2>/dev/null; then wait $BOT_PID; S=$?; echo Bot exited:$S; kill $WEB_PID 2>/dev/null || true; wait $WEB_PID || true; exit $S; else wait $WEB_PID; S=$?; echo Web exited:$S; kill $BOT_PID 2>/dev/null || true; wait $BOT_PID || true; exit $S; fi'",
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 60,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  },
  "checks": {
    "healthcheck": {
      "type": "http",
      "path": "/api/health",
      "interval": 30,
      "timeout": 10,
      "startPeriod": 60
    }
  },
  "env": {
    "NODE_ENV": "production",
    "PYTHONUNBUFFERED": "1",
    "PYTHONDONTWRITEBYTECODE": "1",
    "PYTHONFAULTHANDLER": "1",
    "ENVIRONMENT": "production",
    "LOG_LEVEL": "INFO",
    "WEB_CONCURRENCY": "2",
    "WORKERS_PER_CORE": "1",
    "HOST": "0.0.0.0",
    "PORT": "$PORT",
    "DISABLE_POLLING": "0"
  },
  "plugins": [
    {
      "name": "postgresql",
      "enabled": true
    },
    {
      "name": "redis",
      "enabled": true
    }
  ]
}
