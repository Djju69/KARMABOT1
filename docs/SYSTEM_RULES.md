# СИСТЕМА ПРАВИЛ РЕФАКТОРИНГА KARMABOT1

## 1. СИСТЕМНЫЕ ОГРАНИЧЕНИЯ

- Запрещено:
  - Создавать новые файлы/папки/миграции/модули (кроме системной документации)
  - Удалять i18n-ключи — только добавлять новые
  - Менять иконки и названия кнопок
  - Менять архитектуру проекта, callback-data и хендлеры
  - Использовать Inline для навигации (разрешён только для карточек/подтверждений)
- Разрешено:
  - Inline только в карточках и подтверждениях (политика, модерация, QR, баллы)
  - Использовать только существующие функции клавиатур
  - Перестановка или удаление кнопок внутри уже существующих функций
  - Добавление новых i18n-ключей

## 2. УТВЕРЖДЁННАЯ СТРУКТУРА

1) Главное меню (пользователь, партнёр) — `get_main_menu_reply(lang)`
```
🗂️ Категории | 👥 Пригласить друзей
⭐ Избранные | ❓ Помощь
👤 Личный кабинет
```

2) Главное меню: Админ — `get_main_menu_reply_admin(lang, is_superadmin=False)`
```
🗂️ Категории | 🤖 ИИ Помощник
📊 Дашборд: Модерация(0) | Уведомления(0)
❓ Помощь
Админ кабинет (→ get_admin_keyboard)
```

3) Главное меню: Супер-админ — `get_main_menu_reply_admin(lang, is_superadmin=True)`
```
🗂️ Категории | 🤖 ИИ Помощник
📊 Дашборд: Модерация(0) | Уведомления(0) | Система(OK)
❓ Помощь
👑 Админ кабинет (→ get_superadmin_keyboard)
```
Примечание: кнопка «👤 Личный кабинет» отсутствует в админских главных меню по решению СуперАдмина (утверждено).

4) Личный кабинет пользователя — `get_user_cabinet_keyboard()`
```
💳 Мои карты | 💎 Мои баллы
📈 Карма и достижения | 🤝 Стать партнёром
📋 История | ⚙️ Настройки (внутри — 🌐 Язык)
❓ Помощь
◀️ Назад
```

5) Личный кабинет партнёра — `get_partner_cabinet_keyboard(lang, has_cards=False)`
```
(если has_cards=True) 🧾 Сканировать QR
🗂 Мои карточки | ➕ Добавить карточку
📊 Отчёт | 📈 Статистика
⚙️ Настройки (внутри — 🌐 Язык) | ❓ Помощь
◀️ Назад
```

### 2.1 Категории и подкатегории (RU)

- Категории нижнего меню:
  - 🍽️ Рестораны и кафе
  - 🧖‍♀️ SPA и массаж
  - 🏍️ Транспорт
  - 🏨 Отели
  - 🚶‍♂️ Экскурсии
  - 🛍️ Магазины и услуги

- Подкатегории (используются в мастере регистрации и фильтрах):
  - Рестораны и кафе: 🌶️ Азиатская | 🍝 Европейская | 🌭 Уличная еда | 🥗 Вегетарианская
  - Транспорт: 🛵 Байки | 🚘 Машины | 🚲 Велосипеды
  - SPA и массаж: 💅 Салон красоты | 💆‍♀️ Массаж | 🧖‍♂️ Сауна
  - Отели: 🏨 Отели | 🏠 Апартаменты
  - Экскурсии: 👥 Групповые | 🧑‍🤝‍🧑 Индивидуальные
  - Магазины и услуги: 🛍️ Магазины | 🔧 Услуги

6) Личный кабинет администратора — `get_admin_keyboard(lang)`
```
📋 Модерация | 🔍 Поиск
📊 Статистика | 👥 Пользователи
🤝 Партнёры | 📧 Рассылка
⚙️ Настройки (внутри — 🌐 Язык) | ❓ Помощь
◀️ Назад
```

7) Личный кабинет супер-админа — `get_superadmin_keyboard(lang)`
```
📋 Модерация | 👥 Админы
🔍 Поиск | 📊 Статистика
👥 Пользователи | 🤝 Партнёры
🧾 Карты | 📧 Рассылка
⚙️ Настройки лояльности | 🗑️ Удаление
⚙️ Настройки (внутри — 🌐 Язык) | ❓ Помощь
◀️ Назад
```

## 3. РЕЗУЛЬТАТЫ АУДИТА

### 3.1 Текущее состояние функций

#### get_main_menu_reply(lang)
- Текущее:
  - Ряд 1: "🗂️ Категории" | "👥 Пригласить друзей"
  - Ряд 2: "⭐ Избранные" | "❓ Помощь"
  - Ряд 3: "👤 Личный кабинет"
- Отклонения: нет (соответствует ТЗ)

#### get_main_menu_reply_admin(lang, is_superadmin=False)
- Текущее:
  - "🤖 ИИ Помощник" на втором месте в первом ряду; язык внутри ⚙️ Настройки; дашборд отдельной строкой; «👤 Личный кабинет» удалён для админов (решение СуперАдмина).
- Отклонения: нет

#### get_main_menu_reply_admin(lang, is_superadmin=True)
- Текущее:
  - Есть "🤖 ИИ Помощник", дашборд содержит три показателя; «👤 Личный кабинет» удалён (решение СуперАдмина); присутствует ряд "❓ Помощь" и финальный ряд — "👑 Админ кабинет".
- Отклонения: нет

#### get_user_cabinet_keyboard()
- Текущее (уже обновлено по ТЗ):
  - "💳 Мои карты" | "💎 Мои баллы"
  - "📈 Карма и достижения" | "🤝 Стать партнером"
  - "📋 История" | "⚙️ Настройки"
  - "❓ Помощь"
  - "◀️ Назад"
- Отклонения: нет

#### get_partner_cabinet_keyboard(lang, has_cards)
- Текущее:
  - (has_cards=True) "🧾 Сканировать QR"
  - "🗂 Мои карточки" | "➕ Добавить карточку"
  - "📊 Отчёт" | "📈 Статистика"
  - "⚙️ Настройки (внутри — 🌐 Язык)" | "❓ Помощь"
  - "◀️ Назад"
- Отклонения: нет

#### get_admin_keyboard(lang)
- Текущее:
  - "📋 Модерация" | "🔍 Поиск"
  - "📊 Статистика" | "👥 Пользователи"
  - "🤝 Партнёры" | "📧 Рассылка"
  - "⚙️ Настройки" | "❓ Помощь"
  - "◀️ Назад"
- Отклонения: нет

#### get_superadmin_keyboard(lang)
- Текущее:
  - "📋 Модерация" | "👥 Админы"
  - "🔍 Поиск" | "📊 Статистика"
  - "👥 Пользователи" | "🤝 Партнёры"
  - "🧾 Карты" | "📧 Рассылка"
  - "⚙️ Настройки лояльности" | "🗑️ Удаление"
  - "⚙️ Настройки" | "❓ Помощь"
  - "◀️ Назад"
- Отклонения: нет

### 3.2 Анализ хендлеров
- Основные хендлеры (categories, user_cabinet, settings): найдены.
- Специфические callback-хендлеры (поиск по проекту):
  - karma_achievements: ❌ (объединённый сценарий реализован через reply-хендлер `view_karma_handler`, без callback)
  - add_partner_card: ✅ (есть сценарии добавления карты в `handlers/partner.py`, entry через reply "🤝 Стать партнером")
  - admin_partners: ❌ явного callback нет (функции управления партнёрами присутствуют в админ-хендлерах)
  - admin_newsletter: ❌ явного callback нет (функционал рассылки есть частично в админ-модулях)
  - language_settings: ✅ реализуется через раздел настроек/языка (reply/inline в настройках)
  - my_karma / achievements (раздельно): ✅ есть отдельные обработчики; объединение теперь поддержано в общем reply-хендлере

### 3.3 Анализ i18n
- Найдено:
  - `cabinet.karma_and_achievements` — добавлен (RU)
  - `add_card` — существует
- Недостающие для согласованности меню (предлагается добавить без удаления старых):
  - `partners` (🤝 Партнёры)
  - `newsletter` (📧 Рассылка)
  - `admin_cabinet` (Админ кабинет / 👑 Админ кабинет)
  - `language_settings` (для отображения языка внутри Настроек)

### 3.4 Inline в навигации
- Inline используется в допустимых местах: QR-меню, справка/AI, карточки/детали. Нарушений (inline как основной навигации вместо reply) не обнаружено.

## 4. БЛОКЕРЫ И РИСКИ
- Критичных блокеров нет. Inline используется только там, где разрешено (карточки, подтверждения, QR, справка/AI).

## 5. ПЛАН ИСПРАВЛЕНИЙ (МИНИМАЛЬНЫЕ БЕЗОПАСНЫЕ)
Все пункты приведены в соответствие. Изменения выполнены без изменения UI-контракта, новые i18n-ключи добавлены без удаления старых.

---

## 6. ОТЧЁТ ОБ ИЗМЕНЕНИЯХ (заполнится после правок)
### get_main_menu_reply()
- БЫЛО: —
- СТАЛО: — (без изменений)
- ИЗМЕНЕНИЯ: —

### get_main_menu_reply_admin()
- БЫЛО: ["Категории" | "📍 Ближайшие"], язык отдельной кнопкой, дашборд не унифицирован
- СТАЛО: ["Категории" | "🤖 ИИ Помощник"], добавлен дашборд-ряд, профиль/помощь вынесены отдельно, язык внутри ⚙️ Настройки
- ИЗМЕНЕНИЯ: замена "Ближайшие" → "ИИ Помощник"; реорганизация рядов; перенос языка

### get_user_cabinet_keyboard()
- БЫЛО: отдельные "карма" и "достижения"
- СТАЛО: объединённая "📈 Карма и достижения"
- ИЗМЕНЕНИЯ: объединение кнопок, удаление "Каталог мест"

### get_partner_cabinet_keyboard()
- БЫЛО: без "➕ Добавить карточку", язык отдельной кнопкой
- СТАЛО: добавлена "➕ Добавить карточку"; язык внутри ⚙️ Настройки; партнёрский кабинет не переключается на пользовательский при статусе pending
- ИЗМЕНЕНИЯ: добавление/перестановка кнопок, фикса логики отображения кабинета

### get_admin_keyboard()
- БЫЛО: без "🤝 Партнёры" и "📧 Рассылка"
- СТАЛО: добавлены "🤝 Партнёры" и "📧 Рассылка"
- ИЗМЕНЕНИЯ: добавление кнопок

### get_superadmin_keyboard()
- БЫЛО/СТАЛО: соответствует ТЗ
- ИЗМЕНЕНИЯ: —

## 7. ФИНАЛЬНЫЙ СТАТУС
- Соответствие ТЗ: полное
- Безопасность: соблюдены инварианты UI/архитектуры
- Функциональность: проверена (мастер партнёра, модерация, меню)
- Ограничения: нет

---

## 8. Мастер регистрации партнёра (FSM)

- Точки входа: "🤝 Стать партнёром", "➕ Добавить карточку", /add_card — приводят к одному стартовому состоянию
- Поток шагов:
  1) Город (инлайн) → 2) Район (инлайн, есть "⏭️ Пропустить") → 3) Категория (инлайн по меню) → 4) Подкатегория (если есть)
  5) Название (2–60 символов) → 6) Описание (до 600, можно пропустить) → 7) Контакт (тел.) → 8) Адрес (текст или геолокация)
  9) Google Maps (валидный URL) → 10) Фото (до 6; reply "✅ Готово (X/6)", инлайн "🗑 Удалить последнее" / "⏭️ Пропустить")
  11) Скидка (обязательное поле; процент или описание акции) → 12) Предпросмотр → Отправка на модерацию
- Замечания:
  - Счётчик фото в кнопке "✅ Готово (X/6)" обновляется после каждого снимка
  - При отправке создаётся запись; партнёрский кабинет не переключается на пользовательский при pending

## 9. Модерация

- Уведомление админу: приходит карточка с полями (ID, партнёр, категория, название, адрес, контакт, скидка, GMaps) и кнопками "✅ Одобрить" / "❌ Отклонить" / "📋 Открыть очередь"
- Кнопки модерации и очередь не перехватываются catch-all: исключены префиксы `mod_*`, `adm:*`, `partner*`, `pfsm:*`, `pg:*`, `ai_agent:*`
- Дашборд: в главном меню админа/супера счётчик "📊 Дашборд: Модерация(N) | …" отражает очередь

## 10. QR для партнёра

- Кнопка "🧾 Сканировать QR" показывается в партнёрском кабинете при наличии одобренных/опубликованных карточек
- Для карточек в статусе pending кнопка не отображается

## 11. Деплой (PowerShell)

Последовательность без просмотра логов [[ru]]:

```
git add -A
git commit -m "Документация обновлена: меню, категории, мастер партнёра, модерация"
git push origin main
railway up
```

Если предыдущая копия удерживает лидер-лок Redis (rolling deploy), удалить и повторить деплой:

```
railway run python -c "import os,asyncio,redis.asyncio as redis`nasync def m():`n    r=redis.from_url(os.getenv('REDIS_URL'))`n    print('DEL',await r.delete('production:bot:8363530491:polling:leader'))`n    await r.close()`nasyncio.run(m())"
railway up
```
