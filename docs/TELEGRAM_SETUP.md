# Настройка Telegram бота

Это руководство поможет вам настроить и запустить Telegram бота для интеграции с KarmaSystem.

## Предварительные требования

1. Python 3.8+
2. Установленные зависимости из `requirements.txt`
3. Созданный бот в Telegram через [@BotFather](https://t.me/botfather)
4. Доступ к серверу с белым IP-адресом или туннелем (например, ngrok для тестирования)

## Настройка окружения

1. Запустите скрипт для настройки переменных окружения:
   ```bash
   python setup_telegram_env.py
   ```
   Следуйте инструкциям, чтобы ввести необходимые данные.

2. В файле `.env` должны быть установлены следующие переменные:
   ```
   # Настройки Telegram бота
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   TELEGRAM_BOT_USERNAME=имя_бота
   TELEGRAM_WEBHOOK_URL=https://ваш-домен.com/webhooks/telegram
   TELEGRAM_WEBHOOK_SECRET=сгенерированный_секретный_ключ
   TELEGRAM_LOGIN_REDIRECT_URL=https://ваш-фронтенд.com/auth/telegram/callback
   TELEGRAM_MAX_CONNECTIONS=40
   TELEGRAM_AUTH_EXPIRE_MINUTES=15
   ```

## Установка вебхука

1. Убедитесь, что ваше приложение запущено и доступно по указанному в `TELEGRAM_WEBHOOK_URL` адресу.

2. Установите вебхук с помощью скрипта:
   ```bash
   python scripts/setup_telegram_webhook.py
   ```

3. Проверьте, что вебхук установлен корректно:
   ```bash
   python scripts/test_webhook.py
   ```

## Тестирование

1. Отправьте боту команду `/start` в Telegram
2. Проверьте логи приложения на наличие ошибок
3. Убедитесь, что бот отвечает на команды

## Команды бота

- `/start` - Начать работу с ботом
- `/help` - Показать справку
- `/link` - Привязать аккаунт

## Устранение неполадок

### Вебхук не устанавливается
- Проверьте, что бот имеет правильный токен
- Убедитесь, что URL вебхука доступен из интернета
- Проверьте логи на наличие ошибок

### Бот не отвечает на команды
- Проверьте, что обработчики команд зарегистрированы
- Убедитесь, что бот имеет права на чтение сообщений и управление ими

## Безопасность

- Никогда не публикуйте `TELEGRAM_BOT_TOKEN` и `TELEGRAM_WEBHOOK_SECRET`
- Используйте HTTPS для вебхука
- Ограничьте доступ к API с помощью `TELEGRAM_WEBHOOK_SECRET`

## Дополнительные настройки

Вы можете изменить настройки бота в файле `core/telegram_settings.py` или через соответствующие переменные окружения.
