"""
Enhanced localization with backward compatibility
Extends existing translations without breaking changes
"""
from typing import Dict, Any
import json
from pathlib import Path

# Extended translations (backward compatible)
translations_v2 = {
    'ru': {
        # Existing keys (preserved for compatibility)
        'back_to_main_menu': '–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—éüèò',
        'choose_category': 'üóÇÔ∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏',
        'show_nearest': 'üìç –ü–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ',
        'choose_language': 'üåê –Ø–∑—ã–∫',
        'choose_district': 'üåÜ –ü–æ —Ä–∞–π–æ–Ω–∞–º',
        
        # NEW: P1 additions (profile/help)
        'profile': 'üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç',
        'help': '‚ùì –ü–æ–º–æ—â—å',
        
        # NEW: Partner FSM texts
        'add_card': '‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É',
        'my_cards': 'üìã –ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏',
        'card_status_draft': 'üìù –ß–µ—Ä–Ω–æ–≤–∏–∫',
        'card_status_pending': '‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
        'card_status_approved': '‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ',
        'card_status_published': 'üéâ –û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ',
        'card_status_rejected': '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ',
        'card_status_archived': 'üóÇÔ∏è –ê—Ä—Ö–∏–≤',
        
        # NEW: Moderation texts
        'moderation_title': 'üîç –ú–æ–¥–µ—Ä–∞—Ü–∏—è',
        'approve_card': '‚úÖ –û–¥–æ–±—Ä–∏—Ç—å',
        'reject_card': '‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å',
        'feature_card': '‚≠ê –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ',
        'archive_card': 'üóÇÔ∏è –ê—Ä—Ö–∏–≤',
        
        # NEW: Common actions
        'cancel': '‚ùå –û—Ç–º–µ–Ω–∏—Ç—å',
        'skip': '‚è≠Ô∏è –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å',
        'back': 'üîô –ù–∞–∑–∞–¥',
        'next': '‚û°Ô∏è –î–∞–ª–µ–µ',
        'edit': '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
        'delete': 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
        'save': 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        
        # NEW: Card renderer texts
        'contact_info': 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã',
        'address_info': 'üìç –ê–¥—Ä–µ—Å',
        'discount_info': 'üé´ –°–∫–∏–¥–∫–∞',
        'show_on_map': 'üó∫Ô∏è –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ',
        'create_qr': 'üì± –°–æ–∑–¥–∞—Ç—å QR-–∫–æ–¥',
        'call_business': 'üìû –°–≤—è–∑–∞—Ç—å—Å—è',
        'book_service': 'üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è',
        
        # NEW: Help texts
        'help_main': '''‚ùì **–°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É**

üóÇÔ∏è **–ö–∞—Ç–µ–≥–æ—Ä–∏–∏** - –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≤–µ–¥–µ–Ω–∏–π –ø–æ —Ç–∏–ø–∞–º
üë§ **–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
üìç **–ü–æ–∫–∞–∑–∞—Ç—å –±–ª–∏–∂–∞–π—à–∏–µ** - –ø–æ–∏—Å–∫ —Ä—è–¥–æ–º —Å –≤–∞–º–∏
üåÜ **–ü–æ —Ä–∞–π–æ–Ω–∞–º** - –≤—ã–±–æ—Ä –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
üåê **–Ø–∑—ã–∫** - —Å–º–µ–Ω–∞ —è–∑—ã–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

**–î–ª—è –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤:**
/add_card - –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É
/my_cards - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∞—à–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫

**–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** @support_bot''',
        
        # NEW: Profile texts
        'profile_main': 'üë§ **–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç**',
        'profile_stats': 'üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
        'profile_settings': '‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        'cards_count': '–ö–∞—Ä—Ç–æ—á–µ–∫',
        'views_count': '–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤',
        'qr_scans': 'QR —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π',

        # NEW: Category Menu (v2)
        'category_restaurants': 'üçΩ –†–µ—Å—Ç–æ—Ä–∞–Ω—ã',
        'category_spa': 'üßñ‚Äç‚ôÄÔ∏è SPA',
        'category_transport': 'üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        'category_hotels': 'üè® –û—Ç–µ–ª–∏',
        'category_tours': 'üö∂‚Äç‚ôÇÔ∏è –≠–∫—Å–∫—É—Ä—Å–∏–∏',
        # NEW: Shops & Services main category and submenu
        'category_shops_services': 'üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω—ã –∏ —É—Å–ª—É–≥–∏',
        'shops_choose': '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –º–∞–≥–∞–∑–∏–Ω–æ–≤ –∏ —É—Å–ª—É–≥:',
        'shops_shops': 'üõç –ú–∞–≥–∞–∑–∏–Ω—ã',
        'shops_services': 'üß© –£—Å–ª—É–≥–∏',
        'transport_bikes': 'üõµ –ë–∞–π–∫–∏',
        'transport_cars': 'üöò –ú–∞—à–∏–Ω—ã',
        'transport_bicycles': 'üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥',
        'tours_group': 'üë• –ì—Ä—É–ø–ø–æ–≤—ã–µ',
        'tours_private': 'üßë‚Äçü§ù‚Äçüßë –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ',
        'back_to_categories': '‚óÄÔ∏è –ù–∞–∑–∞–¥',
        'catalog_found': '–ù–∞–π–¥–µ–Ω–æ',
        'catalog_page': '–°—Ç—Ä.',
        'catalog_empty_sub': 'üì≠ –í —ç—Ç–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏–π.',
        'transport_choose': '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:',
        'tours_choose': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —ç–∫—Å–∫—É—Ä—Å–∏–∏:',
        # NEW: SPA and Hotels submenus
        'spa_choose': '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª SPA:',
        'spa_salon': 'üíÜ –°–ø–∞-—Å–∞–ª–æ–Ω—ã',
        'spa_massage': 'ü§≤ –ú–∞—Å—Å–∞–∂',
        'spa_sauna': 'üßñ –ë–∞–Ω–∏/—Å–∞—É–Ω—ã',
        'hotels_choose': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:',
        'hotels_hotels': 'üè® –û—Ç–µ–ª–∏',
        'hotels_apartments': 'üèò –ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã',

        # NEW: Restaurant filters
        'restaurants_choose_cuisine': '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∫—É—Ö–Ω–∏:',
        'filter_asia': '–ê–∑–∏–∞—Ç—Å–∫–∞—è',
        'filter_europe': '–ï–≤—Ä–æ–ø–µ–π—Å–∫–∞—è',
        'filter_street': '–°—Ç—Ä–∏—Ç—Ñ—É–¥',
        'filter_vege': '–í–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å–∫–∞—è',
        'filter_all': '–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ',

        # NEW: Welcome flow
        'welcome_message': '''{user_name} üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Karma System!

‚ú® –ü–æ–ª—É—á–∞–π —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ QR-–∫–æ–¥ –≤ —É–¥–æ–±–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö:
üçΩÔ∏è –†–µ—Å—Ç–æ—Ä–∞–Ω—ã –∏ –∫–∞—Ñ–µ
üßñ‚Äç‚ôÄÔ∏è SPA –∏ –º–∞—Å—Å–∞–∂
üèçÔ∏è –ê—Ä–µ–Ω–¥–∞ –±–∞–π–∫–æ–≤
üè® –û—Ç–µ–ª–∏
üö∂‚Äç‚ôÇÔ∏è –≠–∫—Å–∫—É—Ä—Å–∏–∏

–ê –µ—Å–ª–∏ —Ç—ã –≤–ª–∞–¥–µ–ª–µ—Ü –±–∏–∑–Ω–µ—Å–∞ ‚Äî –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ –Ω–∞–º –∫–∞–∫ –ø–∞—Ä—Ç–Ω—ë—Ä –∏ –ø–æ–¥–∫–ª—é—á–∞–π —Å–≤–æ—é —Å–∏—Å—Ç–µ–º—É –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏! üöÄ

–ù–∞—á–Ω–∏ —ç–∫–æ–Ω–æ–º–∏—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å ‚Äî –≤—ã–±–∏—Ä–∞–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø–æ–ª—É—á–∞–π —Å–≤–æ–∏ —Å–∫–∏–¥–∫–∏!

–ü—Ä–æ–¥–æ–ª–∂–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.''',
        'policy_accept': '‚úÖ –°–æ–≥–ª–∞—Å–µ–Ω',
        'policy_view': 'üìÑ –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏',
        'policy_url': '/policy',  # –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ –Ω–∞—à–µ–º –≤–µ–±-—Å–µ—Ä–≤–∏—Å–µ

        # NEW: Common UI texts required by handlers
        'main_menu_title': 'üèò –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n\n‚ú® –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –Ω–∏–∂–µ –∏ –Ω–∞—á–Ω–∏—Ç–µ —ç–∫–æ–Ω–æ–º–∏—Ç—å —É–∂–µ —Å–µ–π—á–∞—Å!',
        'language_updated': '‚úÖ –Ø–∑—ã–∫ –æ–±–Ω–æ–≤–ª—ë–Ω',
        'policy_accepted': '‚úÖ –ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞',
        'choose_city': 'üåÜ –í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥:',
        'city_selected': '‚úÖ –ì–æ—Ä–æ–¥ –≤—ã–±—Ä–∞–Ω',
        'city_updated': '‚úÖ –ì–æ—Ä–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω',
        'unhandled_message': 'ü§ñ –Ø –≤–∞—Å –Ω–µ –ø–æ–Ω—è–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥.',

        # NEW: WebApp security / errors
        'webapp_auth_invalid': '‚ùå –ù–µ–≤–µ—Ä–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è WebApp. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤—Ö–æ–¥ –∏–∑ Telegram.',
        'webapp_auth_expired': '‚åõ –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –û—Ç–∫—Ä–æ–π—Ç–µ WebApp –∑–∞–Ω–æ–≤–æ –∏–∑ –±–æ—Ç–∞.',
        'webapp_origin_denied': 'üö´ –ò—Å—Ç–æ—á–Ω–∏–∫ –∑–∞–ø—Ä–æ—Å–∞ –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω.',

        # NEW: Reply Menu
        'menu_scan_qr': 'üßæ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR',
        'scan_qr_unavailable': '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞–º —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏.',
        'webapp_open': 'üîó –û—Ç–∫—Ä—ã—Ç—å WebApp',

        # NEW: Partner cabinet navigation
        'btn_more': '‚ãÆ –ï—â—ë',
        'btn_goto_page': '‚û°Ô∏è –ö —Å—Ç—Ä–∞–Ω–∏—Ü–µ‚Ä¶',
        'btn_search_listing': 'üîé –ü–æ–∏—Å–∫',
        'btn_add_offer': '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ',
        'btn_metrics_category': 'üìà –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏',
        'search_placeholder': '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —á–∞—Å—Ç—å –∞–¥—Ä–µ—Å–∞‚Ä¶',
        'search_no_results': '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.',

        # NEW: Reports
        'report_building': '‚è≥ –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á—ë—Ç‚Ä¶ –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.',
        'report_rate_limited': '‚è± –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç—á—ë—Ç–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.',

        # NEW: Inline profile buttons (per spec)
        'btn.points': 'üéÅ –ë–∞–ª–ª—ã',
        'btn.spend': 'üí≥ –ü–æ—Ç—Ä–∞—Ç–∏—Ç—å',
        'btn.history': 'üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π',
        'btn.report': 'üìä –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç',
        'btn.card.bind': 'ü™™ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É',
        'btn.notify.on': 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤–∫–ª)',
        'btn.notify.off': 'üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–≤—ã–∫–ª)',
        'btn.lang': 'üåê –Ø–∑—ã–∫',
        'btn.partner.become': 'üßë‚Äçüíº –°—Ç–∞—Ç—å –ø–∞—Ä—Ç–Ω—ë—Ä–æ–º',

        # NEW: Wallet/card messages
        'wallet.spend.min_threshold': '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ —Å–ø–∏—Å–∞–Ω–∏—è: %{min} pts',
        'wallet.spend.insufficient': '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–∞–ª–ª–æ–≤. –î–æ—Å—Ç—É–ø–Ω–æ: %{points} pts',
        'card.bind.prompt': '–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç—ã (12 —Ü–∏—Ñ—Ä).',
        'card.bind.invalid': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã.',
        'card.bind.occupied': '–ö–∞—Ä—Ç–∞ —É–∂–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –¥—Ä—É–≥–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É.',
        'card.bind.blocked': '–ö–∞—Ä—Ç–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É.',
        # NEW: Bind options
        'card.bind.options': '–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø—Ä–∏–≤—è–∑–∫–∏: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR, –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ QR-–∫–æ–¥–∞ –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é.',
        'card.bind.send_photo': 'üì∑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ QR-–∫–æ–¥–∞',
        'card.bind.enter_manually': '‚å®Ô∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é',
        'card.bind.open_scanner': 'üßæ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)'
        ,
        # NEW: Admin cabinet
        'admin_menu_queue': 'üóÉ –û—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏',
        'admin_menu_search': 'üîé –ü–æ–∏—Å–∫',
        'admin_menu_reports': 'üìä –û—Ç—á—ë—Ç—ã',
        'admin_cabinet_title': 'üõ† –ö–∞–±–∏–Ω–µ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞',
        'admin_hint_queue': '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /moderate –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –∏–ª–∏ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.',
        'admin_hint_search': '–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º –ø–æ—è–≤–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–µ–ª–∏–∑–µ.',
        'admin_hint_reports': '–û—Ç—á—ë—Ç—ã –∏ –º–µ—Ç—Ä–∏–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º —Ä–µ–ª–∏–∑–µ.'
    }
}

def get_text(key: str, lang: str = 'ru') -> str:
    """
    Get localized text with fallback
    Backward compatible with existing code
    """
    # Try new translations first
    if lang in translations_v2 and key in translations_v2[lang]:
        return translations_v2[lang][key]
    
    # Fallback to Russian if key not found in requested language
    if key in translations_v2['ru']:
        return translations_v2['ru'][key]
    
    # Ultimate fallback
    return f"[{key}]"

def get_all_texts(lang: str = 'ru') -> Dict[str, str]:
    """Get all texts for a language"""
    return translations_v2.get(lang, translations_v2['ru'])

def get_supported_languages() -> list:
    """Get list of supported language codes"""
    return list(translations_v2.keys())

# Backward compatibility: expose as 'translations' for existing code
translations = translations_v2

# Export for contract tests
REQUIRED_KEYS = set(translations_v2['ru'].keys())

def validate_translations() -> Dict[str, list]:
    """Validate that all languages have required keys"""
    missing_keys = {}
    
    for lang, texts in translations_v2.items():
        missing = REQUIRED_KEYS - set(texts.keys())
        if missing:
            missing_keys[lang] = list(missing)
    
    return missing_keys


def load_translations_from_dir(dirpath: str = None):
    """Load translations from all JSON files in a directory.
    Each file should be named like 'ru.json', 'en.json', etc., containing a flat {key: text} map.
    """
    global translations_v2, translations
    
    # Use absolute path if dirpath is not provided
    if dirpath is None:
        import os
        dirpath = os.path.join(os.path.dirname(os.path.abspath(__file__)), '..', 'i18n')
    
    p = Path(dirpath)
    if not p.exists():
        print(f"Warning: Translations directory not found: {p.absolute()}")
        return
        
    for file in p.glob("*.json"):
        try:
            with open(file, 'r', encoding='utf-8') as f:
                data = json.load(f)
                lang_code = file.stem
                base = translations_v2.get(lang_code, {})
                base.update(data)
                translations_v2[lang_code] = base
                print(f"Loaded translations for language: {lang_code}")
        except Exception as e:
            print(f"Warning: Failed to load translations from {file}: {e}")
    
    translations = translations_v2

# Auto-load on import
load_translations_from_dir()
