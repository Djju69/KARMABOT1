# Руководство по тестированию KarmaBot

## Запуск тестов

### Запуск всех тестов
```bash
pytest tests/ -v
```

### Запуск тестов с покрытием кода
```bash
# Терминальный отчёт
pytest tests/ --cov=core --cov-report=term

# HTML отчёт (создаст директорию htmlcov/)
pytest tests/ --cov=core --cov-report=html

# Установите минимальный порог покрытия (80%)
pytest tests/ --cov=core --cov-fail-under=80
```

### Запуск определённых тестов
```bash
# Только модульные тесты
pytest tests/unit -v

# Только интеграционные тесты
pytest tests/integration -v

# Только тесты лояльности
pytest tests/test_loyalty_*.py -v

# Запуск теста по имени
pytest -k "test_adjust_balance" -v
```

### Запуск smoke-тестов
```bash
pytest tests/test_smoke_deployment.py -v
```

## Написание тестов

### Структура тестов
- `tests/unit/` - модульные тесты
- `tests/integration/` - интеграционные тесты
- `tests/conftest.py` - общие фикстуры и утилиты
- `tests/test_*.py` - тесты, соответствующие модулям

### Пример модульного теста
```python
import pytest
from unittest.mock import AsyncMock

@pytest.mark.asyncio
async def test_example(mock_cache):
    """Пример теста с моком кэша."""
    mock_cache.get.return_value = "cached_value"
    # ... тестируемый код ...
    mock_cache.get.assert_awaited_once()
```

### Использование фикстур
Доступные фикстуры:
- `mock_db` - мок базы данных
- `mock_cache` - мок кэш-сервиса
- `loyalty_service_mock` - мок сервиса лояльности
- `test_db` - тестовая SQLite база данных

### Тестирование асинхронного кода
Всегда используйте `@pytest.mark.asyncio` для асинхронных тестов и `AsyncMock` для моков асинхронных функций.

## CI/CD

### GitHub Actions
- Тесты запускаются автоматически при каждом пуше в ветки `main` и при пулл-реквестах
- Покрытие кода загружается в Codecov
- Деплой происходит только после успешного прохождения всех тестов

### Проверка покрытия
Минимальный порог покрытия кода - 80%. Сборка упадёт, если покрытие ниже.

## Локальная настройка
1. Установите зависимости для разработки:
   ```bash
   pip install -r requirements-dev.txt
   ```

2. Настройте переменные окружения в `.env` (скопируйте из `.env.example`)

3. Для тестов используется SQLite в памяти, но можно переопределить `DATABASE_URL`

## Отладка тестов

### Запуск с отладочным выводом
```bash
pytest -v -s  # Показывает stdout/stderr
```

### Остановка на первой ошибке
```bash
pytest -x  # Остановка после первой ошибки
```

### Запуск только упавших тестов
```bash
pytest --last-failed
```

## Лучшие практики
1. Каждый тест должен быть независимым
2. Используйте фикстуры для настройки тестовых данных
3. Мокайте внешние зависимости
4. Проверяйте как позитивные, так и негативные сценарии
5. Следите за покрытием кода
