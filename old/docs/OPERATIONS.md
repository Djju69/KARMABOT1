# –û–ø–µ—Ä–∞—Ü–∏–∏: –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–∂–∏–º –ø–æ–ª–ª–∏–Ω–≥–∞, –æ—á–∏—Å—Ç–∫–∞ Redis-–ª–æ–∫–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–∞ –≤–µ–±—Ö—É–∫–∏

## 1) –û–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–∂–∏–º (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–µ–π—á–∞—Å)
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–Ω—Å—Ç–∞–Ω—Å –±–æ—Ç–∞, –æ—Ç–∫–ª—é—á–∏—Ç–µ –ª–∏–¥–µ—Ä-–ª–æ–∫ –∏ –≤–∫–ª—é—á–∏—Ç–µ –ø–æ–ª–ª–∏–Ω–≥:

- ENABLE_POLLING_LEADER_LOCK=0
- DISABLE_POLLING=0
- PREEMPT_LEADER=0

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å –±–æ—Ç–∞ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (—Ä–∞–∑–æ–≤–æ): –æ—á–∏—Å—Ç–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–ª—é—á –ª–æ–∫–∞ –≤ Redis, —Å–º. —Ä–∞–∑–¥–µ–ª 2.

## 2) –†–∞–∑–æ–≤–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–ª—é—á–∞ –≤ Redis
–ö–ª—é—á: `production:bot:polling:leader`

–í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–±:

- –ß–µ—Ä–µ–∑ redis-cli:
```bash
redis-cli -u redis://<host>:<port> -n <db> AUTH <password>
DEL production:bot:polling:leader
```
–ü—Ä–∏–º–µ—Ä—ã –±–µ–∑ AUTH/DB:
```bash
redis-cli -h 127.0.0.1 -p 6379 DEL production:bot:polling:leader
```

- –ß–µ—Ä–µ–∑ docker (–µ—Å–ª–∏ Redis –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ):
```bash
docker exec -it <redis-container> redis-cli DEL production:bot:polling:leader
```

- –ß–µ—Ä–µ–∑ Python (redis-py):
```python
import asyncio
from redis.asyncio import Redis

async def main():
    r = Redis.from_url("redis://<host>:<port>/<db>", password=None)
    await r.delete("production:bot:polling:leader")
    await r.aclose()

asyncio.run(main())
```

–ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç–∞–Ω—Å –±–æ—Ç–∞.

## 3) –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –≤–µ–±—Ö—É–∫–∏ (–ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –¥–æ–º–µ–Ω/HTTPS)
–í–µ–±—Ö—É–∫–∏ —É–±–∏—Ä–∞—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –≤ –ø–æ–ª–ª–∏–Ω–≥–µ: Telegram —Å–∞–º —à–ª—ë—Ç –∞–ø–¥–µ–π—Ç—ã –Ω–∞ –≤–∞—à HTTPS URL.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –í–∞–ª–∏–¥–Ω—ã–π –¥–æ–º–µ–Ω —Å HTTPS (TLS).
- –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –≤–∞—à–µ–º—É FastAPI.

### –®–∞–≥–∏
1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –µ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø—É—Ç—å: `/bot/webhook`.
   - –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–∏—Ç—å FastAPI-—Ä–æ—É—Ç:
   ```python
   from fastapi import APIRouter, Request
   webhook_router = APIRouter()

   @webhook_router.post("/bot/webhook")
   async def telegram_webhook(req: Request):
       update = await req.json()
       # –ø–µ—Ä–µ–¥–∞—Ç—å update –≤ –¥–∏—Å–ø–µ—Ç—á–µ—Ä aiogram
       # await dp.feed_webhook_update(update)
       return {"ok": True}
   ```
   –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ aiogram –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `main_v2.py`.

2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
   - DISABLE_POLLING=1
   - WEBHOOK_URL=https://<your-domain>/bot/webhook

3. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–µ–±—Ö—É–∫ —É Telegram (–æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤):
   - –ß–µ—Ä–µ–∑ curl:
   ```bash
   curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" \
        -d url="https://<your-domain>/bot/webhook"
   ```
   - –ò–ª–∏ —Å–∫—Ä–∏–ø—Ç–æ–º –Ω–∞ Python (requests):
   ```python
   import requests
   BOT_TOKEN = "<YOUR_BOT_TOKEN>"
   WEBHOOK_URL = "https://<your-domain>/bot/webhook"
   r = requests.post(f"https://api.telegram.org/bot{BOT_TOKEN}/setWebhook", data={"url": WEBHOOK_URL})
   print(r.status_code, r.text)
   ```

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É: –ª–æ–≥–∏ FastAPI –¥–æ–ª–∂–Ω—ã –ø–æ–ª—É—á–∞—Ç—å –∞–ø–¥–µ–π—Ç—ã, –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç.

### –û—Ç–∫–∞—Ç –Ω–∞ –ø–æ–ª–ª–∏–Ω–≥
- –£–¥–∞–ª–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –≤–µ–±—Ö—É–∫:
```bash
curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/deleteWebhook"
```
- –í–µ—Ä–Ω—É—Ç—å –ø–æ–ª–ª–∏–Ω–≥:
  - DISABLE_POLLING=0
  - ENABLE_POLLING_LEADER_LOCK=0 (–æ–¥–∏–Ω–æ—á–Ω—ã–π —Ä–µ–∂–∏–º) –∏–ª–∏ 1 (–µ—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –º–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤)

## 4) FAQ
- –ü–æ—á–µ–º—É –±–æ—Ç –∏–Ω–æ–≥–¥–∞ —É—Ö–æ–¥–∏—Ç –≤ idle? ‚Äî –ö–æ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω –ª–∏–¥–µ—Ä-–ª–æ–∫ –∏ –∫–ª—é—á –≤ Redis —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –∏–Ω—Å—Ç–∞–Ω—Å–æ–º.
- –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã 2 –∫–æ–ø–∏–∏? ‚Äî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ª–∏—à–Ω—é—é. –í –æ–¥–∏–Ω–æ—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –¥–µ—Ä–∂–∏—Ç–µ 1 –ø—Ä–æ—Ü–µ—Å—Å –∏ –¥–µ—Ä–∂–∏—Ç–µ `ENABLE_POLLING_LEADER_LOCK=0`.
- –ù—É–∂–Ω–æ –ª–∏ —á–∏—Å—Ç–∏—Ç—å –∫–ª—é—á –≤ Redis –∫–∞–∂–¥—ã–π —Ä–∞–∑? ‚Äî –ù–µ—Ç. –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∫–ª—é—á –æ—Å—Ç–∞–ª—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ –ª–∏–¥–µ—Ä–∞ –∏ –º–µ—à–∞–µ—Ç.

## 5) –†–µ–≥—Ä–µ—Å—Å–∏—è: –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∏–π –∫–∞–±–∏–Ω–µ—Ç (i18n-–∫–Ω–æ–ø–∫–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏)

–ö—Ä–∞—Ç–∫–∏–π —á–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–Ω–æ–ø–æ–∫ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ –º–æ–¥–µ—Ä–∞—Ü–∏–∏.

1. –û–±—â–∏–µ —É—Å–ª–æ–≤–∏—è
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤–∫–ª—é—á—ë–Ω —Ñ–ª–∞–≥ `FEATURE_PARTNER_FSM` (`settings.features.partner_fsm = True`).
   - –ü–æ–ª–∏—Ç–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ (–∏–Ω–∞—á–µ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–∏–Ω—è—Ç—å –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–∏).

2. –ö–Ω–æ–ø–∫–∏ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (Reply)
   - –û—Ç–∫—Ä—ã—Ç—å ¬´üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç¬ª –∏–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é.
   - –ù–∞–∂–∞—Ç—å ¬´‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É¬ª ‚Äî –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å –º–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ (—à–∞–≥ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞).
   - –ù–∞–∂–∞—Ç—å ¬´üìã –ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏¬ª ‚Äî –¥–æ–ª–∂–µ–Ω –æ—Ç–∫—Ä—ã—Ç—å—Å—è —Å–ø–∏—Å–æ–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.
   - –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–ª—è –ª–æ–∫–∞–ª–µ–π ru/en/vi/ko (–∫–Ω–æ–ø–æ—á–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ translations, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —ç–º–æ–¥–∑–∏).

3. –û—Ç–ø—Ä–∞–≤–∫–∞ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è
   - –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∏ ¬´–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é¬ª.
   - –í –∞–¥–º–∏–Ω–∫–µ (/moderate) –æ–¥–æ–±—Ä–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É ‚Äî —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `published`.

4. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ —É –ø–∞—Ä—Ç–Ω—ë—Ä–∞
   - –û—Ç–∫—Ä—ã—Ç—å ¬´–ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏¬ª: –¥–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `published`.
   - –ü–∞–≥–∏–Ω–∞—Ü–∏—è: –∫–Ω–æ–ø–∫–∏ ¬´‚¨ÖÔ∏è –ù–∞–∑–∞–¥ / –í–ø–µ—Ä—ë–¥ ‚û°Ô∏è / üîÑ –û–±–Ω–æ–≤–∏—Ç—å¬ª —Ä–∞–±–æ—Ç–∞—é—Ç, —Å–ø–∏—Å–æ–∫ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.
   - –ü—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ä—Ç–æ—á–∫–∏ (¬´üîé ‚Ä¶¬ª): –¥–æ—Å—Ç—É–ø–Ω—ã –¥–µ–π—Å—Ç–≤–∏—è ¬´üëÅÔ∏è –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å¬ª (`published` ‚Üî `archived`) –∏ ¬´üóë –£–¥–∞–ª–∏—Ç—å¬ª.

5. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
   - –ï—Å–ª–∏ ¬´–ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏¬ª –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –∫–∞—Ä—Ç–æ—á–∫–∏ `approved` –∏–ª–∏ `published` (—Ñ–∏–ª—å—Ç—Ä –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–Ω–æ –ø–æ —ç—Ç–∏–º —Å—Ç–∞—Ç—É—Å–∞–º).
   - –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∏—è –ø–æ –∫–Ω–æ–ø–∫–∞–º –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è: —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –±–∞–∑–æ–≤—ã–π fallback –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç (–≤ `core/handlers/basic.py` –∏—Å–∫–ª—é—á–µ–Ω–∏—è –ø–æ –∫–ª—é—á–∞–º –ø–µ—Ä–µ–≤–æ–¥–æ–≤ `add_card`, `my_cards`, `btn.partner.become`).
