# Техническое задание — Личные кабинеты (сводная версия)

Дата: 2025-08-24

## 1. Общие цели
- Обеспечить партнёрам и администраторам доступ к инструментам управления карточками и модерации через веб-кабинет, интегрированный с Telegram WebApp.
- Минимизировать ручные действия при авторизации: токен из Telegram `initData` или автоподхват сохранённого токена.
- Обеспечить стабильный UX: понятные статусы, предсказуемые сценарии.

## 2. Роли и доступы
- Партнёр (role: `partner`):
  - Создание/редактирование/архивирование собственных карточек.
  - Загрузка изображений карточек.
  - Просмотр статуса модерации.
- Администратор (role: `admin`/`superadmin`):
  - Просмотр всех карточек.
  - Модерация запросов на удаление.
  - Управление категориями/справочниками.

## 3. Авторизация
- Источники токена: `Authorization: Bearer`, cookie (`partner_jwt`/`authToken`/`jwt`), query `?token=` (fallback).
- Telegram WebApp: POST `/auth/webapp` с `initData` → проверка подписи → выдача JWT.
- `get_current_claims()` (кабинет): попытка валидации токена по цепочке: `check_jwt` → `verify_partner` → `verify_admin` → безопасный fallback по payload для ролей `partner/admin/superadmin`.
- Куки: `SameSite=None; Secure` (для встраивания в Telegram).

## 4. Кабинет партнёра — функционал
- Профиль (`GET /cabinet/profile`): возврат `user_id`, `role`, `lang`, `source`.
- Карточки (`/cabinet/partner/cards`):
  - `GET`: список карточек текущего партнёра (или всех — для админа). Фильтры: `status`, `q`, курсор `after_id`, `limit`.
  - `POST`: создание карточки в статусе `pending`.
  - `PATCH /{id}`: частичное редактирование. Чувствительные изменения переводят в `pending`.
  - `POST /{id}/hide`: архив.
- Изображения карточек:
  - `GET/POST/DELETE /cabinet/partner/cards/{id}/images` — список/загрузка/удаление.
- Справочники:
  - `GET /cabinet/partner/categories`
  - `GET /cabinet/partner/subcategories?category_id=...`
  - `GET /cabinet/partner/cities`
  - `GET /cabinet/partner/areas?city_id=...`

## 5. Админ-функции (MVP)
- Запросы на удаление:
  - `POST /admin/cards/{id}/delete_request/approve`
  - `POST /admin/cards/{id}/delete_request/reject`

## 6. UI/UX требования
- SPA-страница `GET /cabinet/partner/cards/page`:
  - Вкладки: «Профиль», «Мои карточки».
  - Профиль: статус авторизации, краткая инфо.
  - Мои карточки: список или пустое состояние «Карточек пока нет». Позже — фильтры/поиск/пагинация, кнопка «Создать» с модалкой.
- Авторизация:
  - Авто-поиск токена: URL → localStorage → cookie.
  - Если нет — попытка Telegram `initData`.
  - Ручной ввод токена: поле ввода + кнопка «Применить токен», поддержка Enter, наглядные статусы.

## 7. Данные и БД
- SQLite `core/database/data.db` (MVP): автосоздание схемы при первом запуске (`partners_v2`, `categories_v2`, `cards_v2`).
- Таблица `cards_v2` — минимальный набор полей (см. код), опциональные поля — `subcategory_id`, `city_id`, `area_id`.

## 8. Нефункциональные
- CSP активен, минимально строгий.
- Логи: префиксы `[auth]`, `[cards]` на фронте; `auth.*` на бэке.
- Производительность: пагинация по `id DESC` + курсор `after_id`.

## 9. Открытые вопросы/ограничения
- Полный фронтенд V2 карточек (таблица/фильтры/модалки) — в работе.
- Интеграция с прод-режимом Telegram: настройка домена/SSL/Headers.
- Обновление токена (refresh) пока отсутствует.

## 10. План доработок (после разморозки)
1) Довести UI карточек V2: таблица, управление, модалки, превью изображений.
2) Интегрировать полноценную загрузку изображений на фронте.
3) Улучшить UX пустого состояния: CTA «Создать карточку».
4) Укрепить авторизацию WebApp: строгая валидация `initData`, человеческие ошибки и ретраи.
5) Тесты: unit + интеграция.
6) Документация деплоя (nginx/CORS/HTTPS/переменные окружения).
