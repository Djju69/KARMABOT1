<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KarmaSystem - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 10px;
        }
        
        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .role-user { background: #e3f2fd; color: #1976d2; }
        .role-partner { background: #f3e5f5; color: #7b1fa2; }
        .role-admin { background: #fff3e0; color: #f57c00; }
        .role-superadmin { background: #ffebee; color: #d32f2f; }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .card h3 {
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .card .value {
            font-size: 24px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #007bff);
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .btn {
            background: var(--tg-theme-button-color, #007bff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .btn-secondary {
            background: var(--tg-theme-secondary-bg-color, #6c757d);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #666666);
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .hidden {
            display: none;
        }
        
        .partner-cards {
            display: grid;
            gap: 15px;
        }
        
        .partner-card {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        
        .partner-card h4 {
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-draft { background: #fff3e0; color: #f57c00; }
        .status-pending { background: #e3f2fd; color: #1976d2; }
        .status-approved { background: #e8f5e8; color: #2e7d32; }
        .status-rejected { background: #ffebee; color: #c62828; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåê KarmaSystem</h1>
            <p>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</p>
            <div id="role-badge" class="role-badge hidden"></div>
        </div>
        
        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
        
        <div id="error" class="error hidden"></div>
        
        <div id="content" class="hidden">
            <!-- –î–∞—à–±–æ—Ä–¥ -->
            <div class="section">
                <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
                <div class="dashboard" id="dashboard">
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è partner/admin/superadmin) -->
            <div id="partner-section" class="section hidden">
                <h2>üè™ –ú–æ–∏ –∫–∞—Ä—Ç–æ—á–∫–∏</h2>
                <button class="btn" onclick="createCard()">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>
                <div id="partner-cards" class="partner-cards">
                    <!-- –ö–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è admin/superadmin) -->
            <div id="moderation-section" class="section hidden">
                <h2>üìã –ú–æ–¥–µ—Ä–∞—Ü–∏—è</h2>
                <div id="moderation-queue">
                    <!-- –û—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è superadmin) -->
            <div id="system-section" class="section hidden">
                <h2>‚öôÔ∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏</h2>
                <button class="btn btn-secondary" onclick="showSystemInfo()">‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let authToken = null;
        const API_BASE = 'https://your-domain.com/api'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è WebApp
        function initWebApp() {
            const tg = window.Telegram?.WebApp;
            if (!tg) {
                showError('Telegram WebApp –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                return;
            }
            
            tg.ready();
            tg.expand();
            
            // –ü–æ–ª—É—á–∞–µ–º initData
            const initData = tg.initData;
            if (!initData) {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                return;
            }
            
            // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è
            authenticate(initData);
        }
        
        // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
        async function authenticate(initData) {
            try {
                const response = await fetch(`${API_BASE}/auth/webapp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ init_data: initData })
                });
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                }
                
                const data = await response.json();
                authToken = data.token;
                currentUser = data.user;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                localStorage.setItem('auth_token', authToken);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                showContent();
                
            } catch (error) {
                showError('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ' + error.message);
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
        function showContent() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–æ–ª—å
            const roleBadge = document.getElementById('role-badge');
            roleBadge.textContent = `–†–æ–ª—å: ${currentUser.role}`;
            roleBadge.className = `role-badge role-${currentUser.role}`;
            roleBadge.classList.remove('hidden');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadDashboard();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏–∏ –ø–æ —Ä–æ–ª–∏
            if (['partner', 'admin', 'superadmin'].includes(currentUser.role)) {
                document.getElementById('partner-section').classList.remove('hidden');
                loadPartnerCards();
            }
            
            if (['admin', 'superadmin'].includes(currentUser.role)) {
                document.getElementById('moderation-section').classList.remove('hidden');
                loadModerationQueue();
            }
            
            if (currentUser.role === 'superadmin') {
                document.getElementById('system-section').classList.remove('hidden');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/stats/overview`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                
                const stats = await response.json();
                renderDashboard(stats);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –¥–∞—à–±–æ—Ä–¥
        function renderDashboard(stats) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            
            const cards = [
                { title: '–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π', value: stats.total_users || 0 },
                { title: '–ü–∞—Ä—Ç–Ω–µ—Ä–æ–≤', value: stats.total_partners || 0 },
                { title: '–ó–∞–≤–µ–¥–µ–Ω–∏–π', value: stats.total_places || 0 }
            ];
            
            if (stats.my_places !== undefined) {
                cards.push({ title: '–ú–æ–∏ –∑–∞–≤–µ–¥–µ–Ω–∏—è', value: stats.my_places });
            }
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="value">${card.value}</div>
                `;
                dashboard.appendChild(cardElement);
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        async function loadPartnerCards() {
            try {
                const response = await fetch(`${API_BASE}/partner/cards`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫');
                
                const data = await response.json();
                renderPartnerCards(data.cards);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–æ—á–µ–∫:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–∞—Ä—Ç–Ω–µ—Ä–∞
        function renderPartnerCards(cards) {
            const container = document.getElementById('partner-cards');
            container.innerHTML = '';
            
            if (cards.length === 0) {
                container.innerHTML = '<p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫</p>';
                return;
            }
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'partner-card';
                cardElement.innerHTML = `
                    <h4>${card.title}</h4>
                    <p>${card.description}</p>
                    <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> ${card.category}</p>
                    <span class="status status-${card.status}">${card.status}</span>
                `;
                container.appendChild(cardElement);
            });
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        async function loadModerationQueue() {
            try {
                const response = await fetch(`${API_BASE}/admin/moderation`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏');
                
                const data = await response.json();
                renderModerationQueue(data);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏:', error);
            }
        }
        
        // –û—Ç–æ–±—Ä–∞–∑–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏
        function renderModerationQueue(data) {
            const container = document.getElementById('moderation-queue');
            container.innerHTML = '';
            
            if (data.partners.length === 0 && data.places.length === 0) {
                container.innerHTML = '<p>–û—á–µ—Ä–µ–¥—å –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø—É—Å—Ç–∞</p>';
                return;
            }
            
            if (data.partners.length > 0) {
                container.innerHTML += '<h3>ü§ù –ü–∞—Ä—Ç–Ω–µ—Ä—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>';
                data.partners.forEach(partner => {
                    const element = document.createElement('div');
                    element.className = 'partner-card';
                    element.innerHTML = `
                        <h4>${partner.title}</h4>
                        <p>üë§ ${partner.contact_name}</p>
                        <p>üìû ${partner.contact_phone}</p>
                    `;
                    container.appendChild(element);
                });
            }
            
            if (data.places.length > 0) {
                container.innerHTML += '<h3>üè™ –ó–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</h3>';
                data.places.forEach(place => {
                    const element = document.createElement('div');
                    element.className = 'partner-card';
                    element.innerHTML = `
                        <h4>${place.title}</h4>
                        <p>üè¢ ${place.partner_name}</p>
                        <p>üìç ${place.address || '–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
                    `;
                    container.appendChild(element);
                });
            }
        }
        
        // –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É
        function createCard() {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.showAlert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            } else {
                alert('–§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        function showSystemInfo() {
            const tg = window.Telegram?.WebApp;
            if (tg) {
                tg.showAlert('–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: 1.0.0\n–°—Ç–∞—Ç—É—Å: –†–∞–±–æ—Ç–∞–µ—Ç');
            } else {
                alert('–í–µ—Ä—Å–∏—è —Å–∏—Å—Ç–µ–º—ã: 1.0.0\n–°—Ç–∞—Ç—É—Å: –†–∞–±–æ—Ç–∞–µ—Ç');
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', initWebApp);
    </script>
</body>
</html>
