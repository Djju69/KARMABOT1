# ТЕХНИЧЕСКОЕ ЗАДАНИЕ: ЛИЧНЫЕ КАБИНЕТЫ KARMABOT1

## 📋 ОБЗОР СИСТЕМЫ

### 🎯 Цель
Реализовать полноценные личные кабинеты для всех типов пользователей с единым интерфейсом и функциональностью через Telegram WebApp.

### 👥 Типы пользователей
1. **USER** - Обычный пользователь
2. **PARTNER** - Партнер (владелец заведения)
3. **MODERATOR** - Модератор
4. **ADMIN** - Администратор
5. **SUPER_ADMIN** - Супер-администратор

## 🏗️ АРХИТЕКТУРА СИСТЕМЫ

### 📁 Структура файлов
```
core/
├── handlers/
│   ├── cabinet_router.py          # Основной роутер кабинетов
│   ├── user_cabinet.py           # Кабинет пользователя
│   ├── partner_cabinet.py        # Кабинет партнера
│   ├── admin_cabinet.py          # Кабинет администратора
│   └── moderator_cabinet.py      # Кабинет модератора
├── services/
│   ├── user_cabinet_service.py   # Сервис пользователя
│   ├── partner_service.py        # Сервис партнера
│   ├── admins_service.py         # Сервис администратора
│   └── moderator_service.py      # Сервис модератора
├── keyboards/
│   ├── cabinet_keyboards.py      # Клавиатуры кабинетов
│   └── admin_keyboards.py        # Админские клавиатуры
└── web/
    └── routes_cabinet.py          # Web API для кабинетов
```

## 🎨 ПОЛЬЗОВАТЕЛЬСКИЕ ИНТЕРФЕЙСЫ

### 👤 КАБИНЕТ ПОЛЬЗОВАТЕЛЯ (USER)

#### Главное меню кабинета
```
👤 Личный кабинет
├── 📊 Мой профиль
├── 💰 Мои баллы
├── 📈 История операций
├── ⭐ Избранные места
├── 🔗 Моя реферальная ссылка
├── 📱 QR-коды и скидки
├── ⚙️ Настройки
└── ◀️ Назад в главное меню
```

#### Детальные экраны

**📊 Мой профиль**
- Имя и username
- Дата регистрации
- Уровень лояльности (Bronze/Silver/Gold)
- Общая статистика

**💰 Мои баллы**
- Текущий баланс
- Всего заработано
- Всего потрачено
- Последние транзакции

**📈 История операций**
- Список всех транзакций
- Фильтры по типу и дате
- Пагинация

**⭐ Избранные места**
- Список сохраненных заведений
- Быстрый доступ к карточкам
- Управление избранным

**🔗 Моя реферальная ссылка**
- Персональная ссылка
- Статистика приглашений
- Доходы от рефералов

**📱 QR-коды и скидки**
- Активные QR-коды
- История использования
- Доступные скидки

### 👨‍💼 КАБИНЕТ ПАРТНЕРА (PARTNER)

#### Главное меню кабинета
```
👨‍💼 Кабинет партнера
├── 📊 Мой профиль
├── 🏢 Мои заведения
├── 📋 Мои карточки
├── 📈 Статистика
├── 💰 Доходы
├── ⚙️ Настройки
└── ◀️ Назад в главное меню
```

#### Детальные экраны

**📊 Мой профиль**
- Информация о бизнесе
- Статус верификации
- Контактные данные

**🏢 Мои заведения**
- Список всех заведений
- Статус каждого заведения
- Быстрое управление

**📋 Мои карточки**
- Создание новых карточек
- Редактирование существующих
- Статус модерации
- Управление изображениями

**📈 Статистика**
- Просмотры карточек
- Сканирования QR-кодов
- Конверсия в посещения
- Аналитика по периодам

**💰 Доходы**
- Общая сумма доходов
- Доходы по периодам
- Детализация по заведениям

### 🛡️ КАБИНЕТ МОДЕРАТОРА (MODERATOR)

#### Главное меню кабинета
```
🛡️ Кабинет модератора
├── 📋 Очередь модерации
├── 🏢 Управление заведениями
├── 👥 Управление партнерами
├── 📊 Статистика модерации
├── ⚙️ Настройки
└── ◀️ Назад в главное меню
```

#### Детальные экраны

**📋 Очередь модерации**
- Новые карточки на проверку
- Запросы на изменения
- Запросы на удаление
- История модерации

**🏢 Управление заведениями**
- Список всех заведений
- Фильтры по статусу
- Массовые операции

**👥 Управление партнерами**
- Список партнеров
- Статус верификации
- Управление доступом

### 👑 КАБИНЕТ АДМИНИСТРАТОРА (ADMIN/SUPER_ADMIN)

#### Главное меню кабинета
```
👑 Админ-панель
├── 📊 Общая статистика
├── 👥 Управление пользователями
├── 🏢 Управление заведениями
├── 🛡️ Управление модераторами
├── 💰 Финансовая отчетность
├── ⚙️ Системные настройки
├── 📈 Аналитика
└── ◀️ Назад в главное меню
```

#### Детальные экраны

**📊 Общая статистика**
- Общее количество пользователей
- Активные партнеры
- Статистика по категориям
- Финансовые показатели

**👥 Управление пользователями**
- Список всех пользователей
- Поиск и фильтрация
- Блокировка/разблокировка
- Управление ролями

**🏢 Управление заведениями**
- Все заведения в системе
- Массовые операции
- Управление категориями
- Настройка комиссий

**🛡️ Управление модераторами**
- Назначение модераторов
- Управление правами доступа
- Статистика работы

**💰 Финансовая отчетность**
- Общие доходы
- Доходы по партнерам
- Комиссии и выплаты
- Экспорт отчетов

**⚙️ Системные настройки**
- Настройки бота
- Управление языками
- Настройки уведомлений
- Резервное копирование

## 🔧 ТЕХНИЧЕСКАЯ РЕАЛИЗАЦИЯ

### 🗄️ База данных

#### Таблица ролей пользователей
```sql
user_roles:
  - user_id (PK, FK users)
  - role (USER, PARTNER, MODERATOR, ADMIN, SUPER_ADMIN)
  - granted_by (FK users) - кто назначил роль
  - granted_at - дата назначения
  - is_active - активна ли роль
```

#### Таблица сессий кабинетов
```sql
cabinet_sessions:
  - id (PK)
  - user_id (FK users)
  - session_token - токен сессии
  - expires_at - время истечения
  - last_activity - последняя активность
  - created_at
```

### 🌐 Web API Endpoints

#### Пользовательские кабинеты
```
GET /cabinet/user/profile
GET /cabinet/user/points
GET /cabinet/user/transactions
GET /cabinet/user/favorites
GET /cabinet/user/referral-stats
```

#### Партнерские кабинеты
```
GET /cabinet/partner/profile
GET /cabinet/partner/establishments
GET /cabinet/partner/cards
POST /cabinet/partner/cards
PUT /cabinet/partner/cards/{id}
DELETE /cabinet/partner/cards/{id}
GET /cabinet/partner/statistics
```

#### Админские кабинеты
```
GET /cabinet/admin/dashboard
GET /cabinet/admin/users
GET /cabinet/admin/partners
GET /cabinet/admin/establishments
GET /cabinet/admin/moderators
GET /cabinet/admin/financial-report
```

### 🔐 Авторизация и безопасность

#### JWT токены
- Access token (15 минут)
- Refresh token (7 дней)
- Роль в payload токена

#### Права доступа
```python
PERMISSIONS = {
    'USER': ['read_profile', 'read_points', 'read_transactions'],
    'PARTNER': ['read_profile', 'manage_cards', 'view_statistics'],
    'MODERATOR': ['moderate_cards', 'manage_partners'],
    'ADMIN': ['manage_users', 'view_financials', 'system_settings'],
    'SUPER_ADMIN': ['all_permissions']
}
```

### 📱 Telegram WebApp интеграция

#### Инициализация
```javascript
// Инициализация WebApp
const webApp = window.Telegram.WebApp;
webApp.ready();
webApp.expand();

// Получение данных пользователя
const user = webApp.initDataUnsafe.user;
const authData = webApp.initData;
```

#### Навигация
```javascript
// Переход между разделами
function navigateToSection(section) {
    // Обновление URL
    window.history.pushState({}, '', `/cabinet/${section}`);
    
    // Загрузка контента
    loadSectionContent(section);
}
```

## 🎨 UI/UX ТРЕБОВАНИЯ

### 📱 Адаптивность
- Мобильная версия (основная)
- Планшетная версия
- Десктопная версия

### 🎨 Дизайн-система
- Цветовая схема: основные цвета бота
- Типографика: читаемые шрифты
- Иконки: единый стиль
- Анимации: плавные переходы

### ♿ Доступность
- Поддержка скрин-ридеров
- Высокий контраст
- Крупные кнопки для мобильных
- Поддержка клавиатурной навигации

## 📊 АНАЛИТИКА И МЕТРИКИ

### 📈 Ключевые метрики
- Время в кабинете
- Количество действий
- Конверсия в целевые действия
- Ошибки и исключения

### 📋 Отчеты
- Ежедневные отчеты по активности
- Еженедельные отчеты по использованию
- Месячные отчеты по эффективности

## 🧪 ТЕСТИРОВАНИЕ

### 🔬 Типы тестов
- Unit тесты для сервисов
- Integration тесты для API
- E2E тесты для пользовательских сценариев
- Performance тесты для нагрузки

### 📝 Тестовые сценарии
1. Авторизация пользователя
2. Создание карточки партнером
3. Модерация карточки
4. Админские операции
5. Обработка ошибок

## 🚀 ПЛАН РЕАЛИЗАЦИИ

### 📅 Этап 1: Базовая структура (1-2 недели)
- [ ] Создание базовой архитектуры
- [ ] Настройка базы данных
- [ ] Базовые API endpoints
- [ ] Простые UI компоненты

### 📅 Этап 2: Пользовательские кабинеты (2-3 недели)
- [ ] Кабинет пользователя
- [ ] Кабинет партнера
- [ ] Базовая функциональность

### 📅 Этап 3: Админские кабинеты (2-3 недели)
- [ ] Кабинет модератора
- [ ] Кабинет администратора
- [ ] Расширенная функциональность

### 📅 Этап 4: Полировка и тестирование (1-2 недели)
- [ ] UI/UX улучшения
- [ ] Тестирование
- [ ] Оптимизация производительности
- [ ] Документация

## 📋 ЧЕКЛИСТ ГОТОВНОСТИ

### ✅ Техническая готовность
- [ ] Все API endpoints работают
- [ ] База данных настроена
- [ ] Авторизация работает
- [ ] WebApp интегрирован

### ✅ Функциональная готовность
- [ ] Все кабинеты реализованы
- [ ] Все функции работают
- [ ] Обработка ошибок
- [ ] Валидация данных

### ✅ Пользовательская готовность
- [ ] UI/UX соответствует требованиям
- [ ] Адаптивность обеспечена
- [ ] Производительность приемлема
- [ ] Документация готова

---

**Статус:** 📝 ТЕХНИЧЕСКОЕ ЗАДАНИЕ ГОТОВО  
**Дата создания:** 09/07/2025  
**Версия:** 1.0  
**Автор:** AI Assistant
