<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- Loyalty Analytics Dashboard Template -->
    <template id="loyalty_analytics_dashboard" name="KarmaBot Loyalty Analytics Dashboard">
        <t t-call="web.layout">
            <t t-set="title">KarmaBot - Loyalty Analytics</t>
            <div class="container mt-4">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-info text-white">
                            <div class="card-body">
                                <h2 class="mb-1">
                                    <i class="fa fa-chart-line"></i> 
                                    Loyalty Analytics Dashboard
                                </h2>
                                <p class="mb-0">Comprehensive analytics for loyalty program performance</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Key Metrics -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-primary">
                                    <t t-esc="analytics.total_users"/>
                                </h4>
                                <p class="mb-0">Total Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-success">
                                    <t t-esc="analytics.active_users"/>
                                </h4>
                                <p class="mb-0">Active Users</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-warning">
                                    <t t-esc="analytics.total_points_earned"/>
                                </h4>
                                <p class="mb-0">Points Earned</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h4 class="text-info">
                                    <t t-esc="analytics.total_points_spent"/>
                                </h4>
                                <p class="mb-0">Points Spent</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-chart-pie"></i> Points Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="pointsChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-chart-bar"></i> Monthly Trends</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="trendsChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Transaction Types -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-list"></i> Transaction Types</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Transaction Type</th>
                                                <th>Count</th>
                                                <th>Total Points</th>
                                                <th>Average Points</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="analytics.transaction_counts" t-as="type_count">
                                                <tr>
                                                    <td>
                                                        <span class="badge badge-info">
                                                            <t t-esc="type_count[0].replace('_', ' ').title()"/>
                                                        </span>
                                                    </td>
                                                    <td><t t-esc="type_count[1]"/></td>
                                                    <td><t t-esc="analytics.type_totals.get(type_count[0], 0)"/></td>
                                                    <td>
                                                        <t t-if="type_count[1] > 0">
                                                            <t t-esc="round(analytics.type_totals.get(type_count[0], 0) / type_count[1], 2)"/>
                                                        </t>
                                                        <t t-else="">0</t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Monthly Trends Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fa fa-calendar"></i> Monthly Trends</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Points Earned</th>
                                                <th>Points Spent</th>
                                                <th>Net Points</th>
                                                <th>Transactions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="analytics.monthly_trends" t-as="month">
                                                <tr>
                                                    <td><t t-esc="month['month']"/></td>
                                                    <td class="text-success">+<t t-esc="month['earned_points']"/></td>
                                                    <td class="text-danger">-<t t-esc="month['spent_points']"/></td>
                                                    <td class="text-info">
                                                        <t t-esc="month['earned_points'] - month['spent_points']"/>
                                                    </td>
                                                    <td><t t-esc="month['transaction_count']"/></td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <small class="text-muted">
                            <i class="fa fa-shield-alt"></i> 
                            Analytics updated in real-time
                        </small>
                    </div>
                </div>
            </div>
            
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                // Points Distribution Chart
                const pointsCtx = document.getElementById('pointsChart').getContext('2d');
                new Chart(pointsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Points Earned', 'Points Spent', 'Points in Circulation'],
                        datasets: [{
                            data: [
                                <t t-esc="analytics.total_points_earned"/>,
                                <t t-esc="analytics.total_points_spent"/>,
                                <t t-esc="analytics.points_circulation"/>
                            ],
                            backgroundColor: [
                                '#28a745',
                                '#dc3545',
                                '#17a2b8'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
                
                // Monthly Trends Chart
                const trendsCtx = document.getElementById('trendsChart').getContext('2d');
                const monthlyData = <t t-esc="json.dumps(analytics.monthly_trends)"/>;
                
                new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: monthlyData.map(m => m.month),
                        datasets: [{
                            label: 'Points Earned',
                            data: monthlyData.map(m => m.earned_points),
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            fill: true
                        }, {
                            label: 'Points Spent',
                            data: monthlyData.map(m => m.spent_points),
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            </script>
        </t>
    </template>
    
</odoo>
