# KarmaSystemBot - ะะพะบัะผะตะฝัะฐัะธั

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะะฐะฟััะบ ัะตััะพะฒ ะปะพะบะฐะปัะฝะพ

1. ะฃััะฐะฝะพะฒะธัะต ะทะฐะฒะธัะธะผะพััะธ:
```bash
pip install -r requirements.txt
pip install pytest pytest-cov pytest-asyncio
```

2. ะะฐัััะพะนัะต ัะตััะพะฒัั ะฑะฐะทั ะดะฐะฝะฝัั PostgreSQL

3. ะะฐะฟัััะธัะต ัะตััั:
```bash
DATABASE_URL=postgresql://user:password@localhost:5432/test_db TESTING=1 pytest tests/ -v
```

### ะกัััะบัััะฐ ัะตััะพะฒ

- `tests/integration/` - ะธะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั
  - `test_admin_*.py` - ัะตััั ะฐะดะผะธะฝ-ะฟะฐะฝะตะปะธ
  - `test_handlers.py` - ัะตััั ะพะฑัะฐะฑะพััะธะบะพะฒ
- `tests/unit/` - ัะฝะธั-ัะตััั

### ะะพะฑะฐะฒะปะตะฝะธะต ะฝะพะฒัั ัะตััะพะฒ

1. ะกะพะทะดะฐะนัะต ัะตััะพะฒัะน ะบะปะฐัั, ัะฝะฐัะปะตะดะพะฒะฐะฝะฝัะน ะพั `BaseBotTest`
2. ะัะฟะพะปัะทัะนัะต `AsyncMock` ะดะปั ะผะพะบะธัะพะฒะฐะฝะธั ะฐัะธะฝััะพะฝะฝัั ะฒัะทะพะฒะพะฒ
3. ะัะพะฒะตััะนัะต ะบะฐะบ ััะฟะตัะฝัะต ััะตะฝะฐัะธะธ, ัะฐะบ ะธ ะพะฑัะฐะฑะพัะบั ะพัะธะฑะพะบ

## ๐ ะะตะฟะปะพะน

### ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั

ะกะพะทะดะฐะนัะต ัะฐะนะป `.env` ัะพ ัะปะตะดัััะธะผะธ ะฟะตัะตะผะตะฝะฝัะผะธ:

```env
DATABASE_URL=postgresql://user:password@host:port/dbname
BOT_TOKEN=your_telegram_bot_token
ADMIN_IDS=12345,67890
```

### Staging

1. ะะฐัััะพะนัะต ะฟะพะดะบะปััะตะฝะธะต ะบ ะฑะฐะทะต ะดะฐะฝะฝัั
2. ะะฐะฟัััะธัะต ะผะธะณัะฐัะธะธ:
```bash
python -m alembic upgrade head
```
3. ะะฐะฟัััะธัะต ะฑะพัะฐ:
```bash
python main_v2.py
```

### Production

1. ะกะพะทะดะฐะนัะต ัะตะณ ัะตะปะธะทะฐ:
```bash
git tag -a v1.0.0 -m "Production release"
git push origin v1.0.0
```

2. ะะฐะฟัััะธัะต ะดะตะฟะปะพะน (ะฟัะธะผะตั ะดะปั Railway):
```bash
railway up --service bot
```

## ๐ง Troubleshooting

### ะงะฐัััะต ะฟัะพะฑะปะตะผั

1. **ะัะธะฑะบะธ ะฟะพะดะบะปััะตะฝะธั ะบ ะะ**
   - ะัะพะฒะตัััะต ัััะพะบั ะฟะพะดะบะปััะตะฝะธั
   - ะฃะฑะตะดะธัะตัั, ััะพ ะะ ะดะพัััะฟะฝะฐ

2. **ะัะพะฑะปะตะผั ั ะฟัะฐะฒะฐะผะธ ะดะพัััะฟะฐ**
   - ะัะพะฒะตัััะต `ADMIN_IDS`
   - ะฃะฑะตะดะธัะตัั, ััะพ ะฟะพะปัะทะพะฒะฐัะตะปั ะดะพะฑะฐะฒะปะตะฝ ะฒ ะฐะดะผะธะฝั

### ะะพะณะธ

ะะพะณะธ ััะฐะฝัััั ะฒ `logs/bot.log`

### ะัะบะฐั

1. ะัะบะฐัะธัะตัั ะบ ะฟัะตะดัะดััะตะผั ัะตะณั:
```bash
git checkout v0.9.0
```
2. ะะตัะตะทะฐะฟัััะธัะต ัะตัะฒะธั

## ๐ ะะพะฝะธัะพัะธะฝะณ

### ะะตััะธะบะธ

- ะะพัััะฟะฝะพััั ัะตัะฒะธัะฐ
- ะัะตะผั ะพัะฒะตัะฐ
- ะะพะปะธัะตััะฒะพ ะพัะธะฑะพะบ
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะตััััะพะฒ

### Alerting

- ะัะธะฑะบะธ 5xx
- Response time > 1000ms
- Memory usage > 80%

## ๐ ะะพะปัะทะพะฒะฐัะตะปััะบะธะต ััะตะฝะฐัะธะธ ะธ ัะธะปัััะฐัะธั (v4.2.5)

### ะะตัะฒัะน ะทะฐะฟััะบ
- `/start` โ inlineโะฒัะฑะพั ัะทัะบะฐ (RU/EN/VI/KO)
- ะกะพััะฐะฝะตะฝะธะต ัะทัะบะฐ ะฒ ะฟัะพัะธะปะต
- ะะพะบะฐะท ะฟะพะปะธัะธะบะธ: inlineโะบะฝะพะฟะบะธ ยซโ ะัะธะฝัััยป / ยซโ ะัะบะปะพะฝะธััยป / ยซ๐ ะะพะปะธัะธะบะฐยป
- ะะพัะปะต ยซะัะธะฝัััยป ะฟะพะบะฐะทัะฒะฐะตััั ะณะปะฐะฒะฝะพะต ะผะตะฝั

### ะะปะฐะฒะฝะพะต ะผะตะฝั (ReplyKeyboard)
- ะัะด 1: `๐๏ธ ะะฐัะตะณะพัะธะธ` ยท `๐ฅ ะัะธะณะปะฐัะธัั ะดััะทะตะน`
- ะัะด 2: `โญ ะะทะฑัะฐะฝะฝัะต` ยท `โ ะะพะผะพัั`
- ะัะด 3: `๐ค ะะธัะฝัะน ะบะฐะฑะธะฝะตั`

### ะะฐัะตะณะพัะธะธ (ReplyKeyboard, 6 ะบะฝะพะฟะพะบ)
- `๐ฝ restaurants` ยท `๐งโโ spa` ยท `๐ transport` ยท `๐จ hotels` ยท `๐ถโโ tours` ยท `๐๏ธ shops`
- ะะฑัะฐะฑะพััะธะบะธ: `core/handlers/main_menu_router.py` ะธ `core/handlers/category_handlers_v2.py`

### ะะตััะพัะฐะฝั โ ัะธะปัััะฐัะธั (Inline)
- ะะพัะปะต ะฒัะฑะพัะฐ `๐ฝ restaurants` ะฟะพะบะฐะทัะฒะฐะตััั ัะพะพะฑัะตะฝะธะต ยซะัะฑะตัะธัะต ะบััะฝั:ยป ะธ inlineโะบะปะฐะฒะธะฐัััะฐ:
  - `๐ฅข ะะทะธะฐััะบะฐั` โ `filt:restaurants:asia`
  - `๐ ะะฒัะพะฟะตะนัะบะฐั` โ `filt:restaurants:europe`
  - `๐ญ ะกััะธัโััะด` โ `filt:restaurants:street`
  - `๐ฅ ะะตะณะตัะฐัะธะฐะฝัะบะฐั` โ `filt:restaurants:vege`
  - `๐ ะะพะบะฐะทะฐัั ะฒัะต` โ `filt:restaurants:all`
- ะะพ ัะธะปัััั ะทะฐะฟััะบะฐะตััั ะตะดะธะฝัะน ัะตะฝะดะตั ะบะฐััะพัะตะบ `show_catalog_page(...)`

### ะะพะดะบะฐัะตะณะพัะธะธ (Reply)
- ะขัะฐะฝัะฟะพัั: `๐๏ธ ะะฐะนะบะธ` ยท `๐ ะะฐัะธะฝั` ยท `๐ฒ ะะตะปะพัะธะฟะตะดั` ยท `โ๏ธ ะะฐะทะฐะด`
- ะญะบัะบัััะธะธ: `๐ฅ ะััะฟะฟะพะฒัะต` ยท `๐งโ๐คโ๐ง ะะฝะดะธะฒะธะดัะฐะปัะฝัะต` ยท `โ๏ธ ะะฐะทะฐะด`
- SPA: `ะกะฐะปะพะฝั` ยท `ะะฐััะฐะถ` ยท `ะกะฐัะฝะฐ` ยท `โ๏ธ ะะฐะทะฐะด`
- ะัะตะปะธ: `ะัะตะปะธ` ยท `ะะฟะฐััะฐะผะตะฝัั` ยท `โ๏ธ ะะฐะทะฐะด`

### ะะฐะณะธะฝะฐัะธั
- ะคะพัะผะฐั callback: `pg:<slug>:<sub_slug>:<page>`
- ะะฑัะฐะฑะพััะธะบ: `on_catalog_pagination` ะฒ `category_handlers_v2.py`
- ะกะพััะพัะฝะธะต FSM ัะพััะฐะฝัะตั: `{ category, sub_slug, page }`

### ะะดะธะฝัะน ัะตะฝะดะตั ะบะฐััะพัะตะบ
- ะัะทะพะฒ: `show_cards(user_id, category, sub_slug=None, page=1)` โ ะฒะฝัััะธ ะฒัะทัะฒะฐะตั `show_catalog_page`
- ะััะพัะฝะธะบ ะดะฐะฝะฝัั: `db_v2.get_cards_by_category(...)`

### ะะพะณะธ ะธ ะฐัะดะธั
- ะัะต ะบะปััะตะฒัะต ะดะตะนััะฒะธั ะปะพะณะธัััััั (ะพัะบัััะธะต ะบะฐัะตะณะพัะธะน, ัะธะปัััั, ะฟะฐะณะธะฝะฐัะธั)
- ะัะธะฝััะธะต ะฟะพะปะธัะธะบะธ ะธ ะฒัะฑะพั ัะทัะบะฐ ัะธะบัะธัััััั
